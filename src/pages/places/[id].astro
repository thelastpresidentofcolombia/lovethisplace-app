---
//  src/pages/places/[id].astro  –  RESPONSIVE-ENHANCED FILE
import AuthLayout from "../../layouts/AuthLayout.astro";
import PhotoGallery from "../../components/PhotoGallery.astro";
import { Icon } from "astro-icon/components";
import { adminDb } from "../../lib/firebase/admin";

/* ─── server ─────────────────────────────────────────────────────────────── */
const { id } = Astro.params;
const ref = Astro.url.searchParams.get("ref");
if (!id) return Astro.redirect("/404");

const snap = await adminDb
    .collection("venues")
    .where("id", "==", id)
    .limit(1)
    .get()
    .catch(() => null);

if (!snap || snap.empty) return Astro.redirect("/404");

const venue = snap.docs[0].data();

let recommendation = null;
if (ref) {
    const noteQuery = adminDb
        .collection("notes")
        .where("propertyId", "==", id)
        .where("referrerId", "==", ref)
        .orderBy("createdAt", "desc")
        .limit(1);
    const noteSnap = await noteQuery.get();
    if (!noteSnap.empty) {
        recommendation = noteSnap.docs[0].data();
        recommendation.referrerName = "A friend";
    }
}

const bookingUrl =
    `https://www.elitecartagena.com/villas/${id}` +
    `?utm_source=elite_portal&utm_medium=referral` +
    (ref ? `&utm_campaign=${ref}` : "");

const preload = venue.imageUrls?.[0]
    ? [{ rel: "preload", href: venue.imageUrls[0], as: "image" }]
    : [];
---

<AuthLayout title={venue.name} preload={preload}>
    <header
        class="relative isolate h-[45vh] min-h-[260px] sm:min-h-[340px] md:min-h-[420px] lg:min-h-[480px] overflow-hidden"
        style="padding-top:env(safe-area-inset-top, 1.5rem);"  <!-- Add top padding for logo/nav -->
    >
        <div
            class="hero-bg absolute inset-0 bg-cover bg-center"
            style={`background-image:url('${venue.imageUrls[0]}')`}
        ></div>
        <div
            class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/40 to-transparent"
        ></div>
        <div
            class="absolute bottom-0 inset-x-0 h-24 bg-[linear-gradient(transparent,theme(colors.sand/10))]"
        ></div>
    </header>

    <div
        class="lg:hidden fixed bottom-0 inset-x-0 z-40 backdrop-blur
           bg-white/95 dark:bg-dark-bg/95 border-t border-ink/10 dark:border-sand/20 shadow-lg"
        style="box-shadow: 0 -2px 16px rgba(0,0,0,0.08);"
    >
        <div
            class="max-w-2xl mx-auto flex items-center justify-between px-4 py-4"
        >
            <div>
                <p class="font-display text-xl font-bold">
                    {venue.price.split("/")[0]}
                </p>
                <p class="text-xs text-ink/70 dark:text-sand/70">per night</p>
            </div>
            <a
                href={bookingUrl}
                target="_blank"
                class="px-6 py-3 rounded-full bg-coral text-white font-bold shadow
        hover:shadow-lg hover:scale-105 active:scale-95 transition"
            >
                Book now
            </a>
        </div>
    </div>

    <main class="w-full max-w-3xl md:max-w-4xl lg:max-w-7xl mx-auto px-2 sm:px-4 md:px-6 lg:px-8 pb-32 pt-6 md:pt-12">
        <div class="lg:grid lg:grid-cols-[minmax(0,1fr)_380px] lg:gap-14">
            <article class="w-full space-y-8 lg:space-y-12">
                <section
                    class="bg-white dark:bg-dark-bg rounded-2xl p-4 sm:p-6 md:p-10 shadow-2xl space-y-4"
                >
                    <h1
                        class="font-display text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-extrabold leading-tight"
                    >
                        {venue.name}
                    </h1>
                    <p
                        class="flex flex-wrap items-center gap-2 text-ink/70 dark:text-sand/70 text-sm md:text-base"
                    >
                        <Icon name="ph:map-pin-fill" class="w-4 h-4" />
                        {venue.neighborhood}, Cartagena
                        <span class="w-1 h-1 rounded-full bg-current opacity-40"></span>
                        <Icon name="ph:star-fill" class="w-4 h-4 text-amber-400" />
                        {venue.rating || "5.0"}
                    </p>
                </section>

                {
                    recommendation && (
                        <section class="bg-mint/20 dark:bg-mint/10 border-l-4 border-mint rounded-lg p-4 sm:p-6 md:p-8">
                            <h3 class="font-bold text-lg sm:text-xl mb-2 text-ink dark:text-sand">
                                A note from {recommendation.referrerName}:
                            </h3>
                            <p class="text-base sm:text-lg italic text-ink/80 dark:text-sand/80">
                                “{recommendation.note}”
                            </p>
                        </section>
                    )
                }

                <PhotoGallery
                    images={venue.imageUrls}
                    venueName={venue.name}
                    class="aspect-[1.85/1] md:aspect-[4/3] lg:rounded-2xl shadow-xl"
                />

                <section
                    class="space-y-8 sm:space-y-10 rounded-2xl border border-ink/10 dark:border-sand/20 p-4 sm:p-6 md:p-8 shadow-sm"
                >
                    <div class="space-y-4 sm:space-y-6">
                        <h2 class="font-display text-2xl sm:text-3xl font-bold">
                            Villa Highlights
                        </h2>
                        <div class="grid gap-x-4 gap-y-6 sm:grid-cols-2">
                            {
                                [
                                    {
                                        icon: "ph:house-line-fill",
                                        label: "Property type",
                                        value: "Luxury private villa",
                                    },
                                    {
                                        icon: "ph:users-three-fill",
                                        label: "Capacity",
                                        value: `Up to ${venue.guests} guests`,
                                    },
                                    {
                                        icon: "ph:bed-fill",
                                        label: "Bedrooms",
                                        value: `${venue.bedrooms} suites`,
                                    },
                                    {
                                        icon: "ph:bathtub-fill",
                                        label: "Bathrooms",
                                        value: `${
                                            venue.bathrooms || venue.bedrooms
                                        } designer baths`,
                                    },
                                ].map((card) => (
                                    <div class="flex items-start gap-3 sm:gap-4">
                                        <Icon
                                            name={card.icon}
                                            class="w-6 h-6 sm:w-7 sm:h-7 text-coral mt-1 flex-shrink-0"
                                        />
                                        <div>
                                            <h3 class="font-semibold">
                                                {card.label}
                                            </h3>
                                            <p class="text-ink/80 dark:text-sand/80 text-sm">
                                                {card.value}
                                            </p>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>

                    <hr class="border-ink/10 dark:border-sand/20" />

                    <div class="space-y-4 sm:space-y-6">
                        <h2 class="font-display text-2xl sm:text-3xl font-bold">
                            About this Villa
                        </h2>
                        <div id="description-wrapper" class="relative">
                            <div
                                id="description-content"
                                class="prose prose-base sm:prose-lg dark:prose-invert max-w-none space-y-4 overflow-hidden max-h-48 transition-all duration-500"
                            >
                                {
                                    venue.description
                                        .split("\n")
                                        .map((p) => <p>{p}</p>)
                                }
                            </div>
                            <div
                                id="read-more-container"
                                class="absolute bottom-0 inset-x-0 pt-8 sm:pt-12 bg-gradient-to-t from-white dark:from-dark-bg to-transparent"
                            >
                                <button
                                    id="read-more-btn"
                                    class="font-bold text-coral hover:underline"
                                >
                                    Read more
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                {
                    venue.amenities?.length && (
                        <section class="space-y-4 sm:space-y-6 rounded-2xl border border-ink/10 dark:border-sand/20 p-4 sm:p-8 shadow-sm">
                            <h2 class="font-display text-2xl sm:text-3xl font-bold">
                                Exclusive Amenities
                            </h2>
                            <ul class="grid gap-3 sm:gap-4 grid-cols-[repeat(auto-fit,minmax(160px,1fr))]">
                                {venue.amenities.map((a) => (
                                    <li class="flex items-center gap-2 sm:gap-3">
                                        <Icon
                                            name="ph:check-circle"
                                            class="w-5 h-5 text-mint flex-shrink-0"
                                        />
                                        <span class="text-sm">{a}</span>
                                    </li>
                                ))}
                            </ul>
                        </section>
                    )
                }
            </article>

            <aside class="hidden lg:block sticky top-32 self-start">
                <div
                    class="rounded-2xl border border-ink/10 dark:border-sand/20
             bg-white dark:bg-dark-bg shadow-lg overflow-hidden"
                >
                    <div
                        class="p-6 flex justify-between gap-6 border-b border-ink/10 dark:border-sand/20"
                    >
                        <div>
                            <p class="font-display text-3xl font-bold">
                                {venue.price.split("/")[0]}
                            </p>
                            <p class="text-xs text-ink/70 dark:text-sand/70">
                                per night
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="flex items-center gap-1 justify-end">
                                <Icon
                                    name="ph:star-fill"
                                    class="w-4 h-4 text-amber-400"
                                />
                                {venue.rating || "5.0"}
                            </p>
                            <p class="text-xs text-ink/70 dark:text-sand/70">
                                {venue.reviewCount || "10+"} reviews
                            </p>
                        </div>
                    </div>

                    <div class="p-6">
                        <a
                            href={bookingUrl}
                            target="_blank"
                            class="block w-full text-center px-6 py-4 bg-coral text-white font-bold
            rounded-full hover:scale-105 active:scale-95 transition"
                        >
                            Book your stay
                        </a>
                        <p
                            class="mt-3 text-center text-xs text-ink/70 dark:text-sand/70"
                        >
                            Secure checkout on EliteCartagena.com
                        </p>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <style is:global>
        body {
            overflow-x: hidden;
        }
        .hero-bg {
            will-change: transform;
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @media (max-width: 1023px) {
            main {
                padding-bottom: 6rem !important; /* Ensure content is not covered by booking bar */
            }
        }
    </style>

    <script is:inline>
        addEventListener("scroll", () => {
            const h = document.querySelector(".hero-bg");
            h && (h.style.transform = `translateY(${scrollY * 0.25}px)`);
        });
    </script>

    <script is:inline>
        const wrapper = document.getElementById("description-wrapper");
        const content = document.getElementById("description-content");
        const btnContainer = document.getElementById("read-more-container");
        const btn = document.getElementById("read-more-btn");

        if (content && btnContainer && btn) {
            if (content.scrollHeight <= content.clientHeight) {
                btnContainer.style.display = "none";
            } else {
                btn.addEventListener("click", () => {
                    content.style.maxHeight = content.scrollHeight + "px";
                    wrapper.removeChild(btnContainer);
                });
            }
        }
    </script>
</AuthLayout>
