---
import AuthLayout from "../../layouts/AuthLayout.astro";
import PhotoGallery from "../../components/PhotoGallery.astro";
import { Icon } from "astro-icon/components";
import { adminDb } from "../../lib/firebase/admin";

const { id } = Astro.params;
const ref = Astro.url.searchParams.get("ref");
if (!id) return Astro.redirect("/404");

const snap = await adminDb
    .collection("venues")
    .where("id", "==", id)
    .limit(1)
    .get()
    .catch(() => null);

if (!snap || snap.empty) return Astro.redirect("/404");

const venue = snap.docs[0].data();

let recommendation = null;
if (ref) {
    const noteQuery = adminDb
        .collection("notes")
        .where("propertyId", "==", id)
        .where("referrerId", "==", ref)
        .orderBy("createdAt", "desc")
        .limit(1);
    const noteSnap = await noteQuery.get();
    if (!noteSnap.empty) {
        recommendation = noteSnap.docs[0].data();
        recommendation.referrerName = "A friend";
    }
}

const bookingUrl =
    `https://www.elitecartagena.com/villas/${id}` +
    `?utm_source=elite_portal&utm_medium=referral` +
    (ref ? `&utm_campaign=${ref}` : "");

const preload = venue.imageUrls?.[0]
    ? [{ rel: "preload", href: venue.imageUrls[0], as: "image" }]
    : [];
---

<AuthLayout title={venue.name} preload={preload}>
    <div
        class="lg:hidden sticky top-0 inset-x-0 z-40 backdrop-blur
           bg-white/80 dark:bg-dark-bg/80 border-b border-ink/10 dark:border-sand/20"
    >
        <div
            class="max-w-7xl mx-auto flex items-center justify-between px-4 py-3"
        >
            <div>
                <p class="font-display text-lg font-bold">
                    {venue.price.split("/")[0]}
                </p>
                <p class="text-xs text-ink/70 dark:text-sand/70">per night</p>
            </div>
            <a
                href={bookingUrl}
                target="_blank"
                class="px-5 py-2.5 rounded-full bg-coral text-white font-bold shadow
        hover:shadow-lg hover:scale-105 active:scale-95 transition text-sm"
            >
                Book now
            </a>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="lg:grid lg:grid-cols-[minmax(0,1fr)_380px] lg:gap-14">
            <article class="w-full space-y-8">
                <section class="space-y-3">
                    <h1
                        class="font-display text-4xl md:text-5xl font-extrabold leading-tight"
                    >
                        {venue.name}
                    </h1>
                    <p
                        class="flex items-center gap-3 text-ink/70 dark:text-sand/70"
                    >
                        <Icon name="ph:map-pin-fill" class="w-4 h-4" />
                        {venue.neighborhood}, Cartagena
                        <span class="w-1 h-1 rounded-full bg-current opacity-40"
                        ></span>
                        <Icon
                            name="ph:star-fill"
                            class="w-4 h-4 text-amber-400"
                        />
                        {venue.rating || "5.0"}
                    </p>
                </section>

                {
                    recommendation && (
                        <section class="bg-mint/20 dark:bg-mint/10 border-l-4 border-mint rounded-lg p-6">
                            <h3 class="font-bold text-xl mb-2 text-ink dark:text-sand">
                                A note from {recommendation.referrerName}:
                            </h3>
                            <p class="text-lg italic text-ink/80 dark:text-sand/80">
                                “{recommendation.note}”
                            </p>
                        </section>
                    )
                }

                <PhotoGallery
                    images={venue.imageUrls}
                    venueName={venue.name}
                    class="aspect-video lg:rounded-2xl shadow-xl overflow-hidden"
                />
            </article>

            <aside class="hidden lg:block lg:sticky top-8 self-start">
                <div
                    class="rounded-2xl border border-ink/10 dark:border-sand/20 bg-white dark:bg-dark-bg shadow-lg overflow-hidden"
                >
                    <div
                        class="p-6 flex justify-between gap-6 border-b border-ink/10 dark:border-sand/20"
                    >
                        <div>
                            <p class="font-display text-3xl font-bold">
                                {venue.price.split("/")[0]}
                            </p>
                            <p class="text-xs text-ink/70 dark:text-sand/70">
                                per night
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="flex items-center gap-1 justify-end">
                                <Icon
                                    name="ph:star-fill"
                                    class="w-4 h-4 text-amber-400"
                                />
                                {venue.rating || "5.0"}
                            </p>
                            <p class="text-xs text-ink/70 dark:text-sand/70">
                                {venue.reviewCount || "10+"} reviews
                            </p>
                        </div>
                    </div>
                    <div class="p-6">
                        <a
                            href={bookingUrl}
                            target="_blank"
                            class="block w-full text-center px-6 py-4 bg-coral text-white font-bold rounded-full hover:scale-105 active:scale-95 transition"
                        >
                            Book your stay
                        </a>
                    </div>
                </div>
            </aside>
        </div>
    </main>
</AuthLayout>
